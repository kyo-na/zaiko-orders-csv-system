<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>注文履歴</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body class="bg-light">
  <div class="container py-4">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <h1 class="h3 mb-0">注文履歴</h1>
      <div class="d-flex gap-2">
        <a class="btn btn-outline-secondary" href="/">注文票</a>
        <a class="btn btn-outline-secondary" href="/inventory/">在庫</a>
      </div>
    </div>

    <div class="card mb-3">
      <div class="card-body">
        <div class="row g-3 align-items-end">
          <div class="col-md-3">
            <label class="form-label">開始日</label>
            <input id="start" type="date" class="form-control">
          </div>
          <div class="col-md-3">
            <label class="form-label">終了日</label>
            <input id="end" type="date" class="form-control">
          </div>
          <div class="col-md-4">
            <label class="form-label">名前（任意）</label>
            <select id="name" class="form-select"></select>
          </div>
          <div class="col-md-2">
            <button id="btn-search" class="btn btn-primary w-100">検索</button>
          </div>
        </div>
      </div>
    </div>

    <h2 class="h5">集計（おかず別）</h2>
    <div class="card mb-4">
      <div class="card-body">
        <canvas id="pie" height="220"></canvas>
      </div>
    </div>

    <h2 class="h5">履歴一覧（確定済みのみ）</h2>
    <div class="table-responsive">
      <table class="table table-sm table-striped align-middle">
        <thead>
          <tr>
            <th>日時</th>
            <th>名前</th>
            <th>おかず</th>
            <th>おかず期限</th>
            <th>ご飯</th>
            <th>ご飯期限</th>
          </tr>
        </thead>
        <tbody id="body"></tbody>
      </table>
    </div>
  </div>

<script>
var elStart = document.getElementById('start');
var elEnd = document.getElementById('end');
var elName = document.getElementById('name');
var elBody = document.getElementById('body');
var pieCanvas = document.getElementById('pie');
var pieObj = null;

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, function(m){
    return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]);
  });
}
function fmtIso(iso){
  try { return new Date(iso).toLocaleString(); } catch(e) { return iso; }
}

function setSelectOptions(el, arr){
  el.innerHTML = '';
  var op0 = document.createElement('option');
  op0.value = '';
  op0.textContent = '(全員)';
  el.appendChild(op0);

  for (var i=0;i<arr.length;i++){
    var op = document.createElement('option');
    op.value = arr[i];
    op.textContent = arr[i];
    el.appendChild(op);
  }
}

async function loadNames(){
  var o = await fetch('/api/options/').then(function(r){ return r.json(); });
  setSelectOptions(elName, o.names || []);
}

function buildQuery(){
  var p = new URLSearchParams();
  if (elStart.value) p.set('start', elStart.value);
  if (elEnd.value) p.set('end', elEnd.value);
  if (elName.value) p.set('name', elName.value);
  return p.toString();
}

function drawPie(labels, values){
  if (pieObj) pieObj.destroy();
  pieObj = new Chart(pieCanvas.getContext('2d'), {
    type: 'pie',
    data: {
      labels: labels,
      datasets: [{ data: values }]
    }
  });
}

async function search(){
  var q = buildQuery();
  var data = await fetch('/api/history/?' + q).then(function(r){ return r.json(); });
  var rows = data.orders || [];

  elBody.innerHTML = '';
  for (var i=0;i<rows.length;i++){
    var o = rows[i];
    var tr = document.createElement('tr');
    tr.innerHTML = ''
      + '<td>' + escapeHtml(fmtIso(o.created_at)) + '</td>'
      + '<td>' + escapeHtml(o.name) + '</td>'
      + '<td>' + escapeHtml(o.okazu) + '</td>'
      + '<td>' + escapeHtml(o.okazu_expiry) + '</td>'
      + '<td>' + escapeHtml(o.gohan) + '</td>'
      + '<td>' + escapeHtml(o.gohan_expiry) + '</td>';
    elBody.appendChild(tr);
  }

  var sum = await fetch('/api/summary/?' + q).then(function(r){ return r.json(); });
  drawPie(sum.labels || [], sum.values || []);
}

document.getElementById('btn-search').addEventListener('click', search);

loadNames().then(search);
</script>
</body>
</html>
